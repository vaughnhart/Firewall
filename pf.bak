#
# PF configuration file for macOS - Generated by AI from my pf.conf
#

# Tables
table <bad_actors> persist file "/etc/bad_actors.txt"
table <abusers1d> const file "/etc/firehol_abusers_1d.netset"
table <level2> const file "/etc/firehol_level2.netset"
table <level3> const file "/etc/firehol_level3.netset"
table <webclient> const file "/etc/firehol_webclient.netset"
table <csix> file "/etc/ipblocklist.txt"

# Options
set block-policy drop
set fingerprints "/etc/pf.os"
set ruleset-optimization basic
set limit { tables 10000, table-entries 400000 }
#set syncookies adaptive # Enable only if under SYN flood attack

# Scrubbing (Normalization)
scrub in all no-df
scrub-anchor "cisco.anyconnect.vpn"
scrub-anchor "com.apple/*"

# Anchors
nat-anchor "com.apple/*"
rdr-anchor "com.apple/*"
dummynet-anchor "com.apple/*"
anchor "cisco.anyconnect.vpn"
anchor "com.apple/*"
load anchor "com.apple" from "/etc/pf.anchors/com.apple"

# Default deny all inbound
block in log all

# Allow DHCP
pass in inet proto udp from port 67 to port 68
pass in inet6 proto udp from port 547 to port 546

# Block QUIC protocol (UDP/253) and 6to4 tunneling (Protocol 41)
block log quick proto {253, 41} from any to any

# Antispoofing and Block Non-routable Addresses
antispoof log for self
block in log quick from no-route to any
block in log quick from urpf-failed to any
block in log quick on self from any to 255.255.255.255

# Block traffic from known bad actors (using tables)
block in log quick on self from <bad_actors> to any
block in log quick on self from <abusers1d> to any
block in log quick on self from <level2> to any
block in log quick on self from <level3> to any
block in log quick on self from <webclient> to any
block in log quick on self from <csix> to any

# Block packets with source port 0
block log quick proto { tcp, udp } from any port = 0 to any

# Per-interface blocking (experiment - be careful with these)
block in on self proto {253, 41} # Blocks protocols 253 and 41 on internal interfaces.

# Allow loopback
pass in from 127.0.0.1
pass in from ::1

# Block traffic from unknown OS (fingerprinting)
block out from any os "unknown"

# Block specific services (inbound)
block in log proto tcp to any port { 548, 20, 21, 80, 143, 993, 110, 995, 3031, 5900, 25, 23, 3689, 540, 49152} #AFP, FTP, HTTP, IMAP/S, POP3/S, Remote Apple Events, Screen Sharing, SMTP, Telnet, iTunes Sharing, UUCP, Optical Drive Sharing
block in log proto { tcp, udp } to any port { 139, 445, 137, 138, 69 } # SMB, TFTP
block in log proto udp to any port {1900, 5353} #Bonjour SSDP, mDNSResponder
block in log proto tcp to any port {79, 2049} #Finger, NFSblock in log proto icmp # ICMP

# Default pass out rule
pass out log all keep state

# Allow outbound to specific DNS servers (Cisco Umbrella) - Important for DNS resolution
pass out log quick proto {tcp, udp} from any to {208.67.220.220, 208.67.222.222, 2620:119:35::35, 2620:119:53::53}

# Outbound blocked tablesblock log quick from any to <bad_actors>
block log quick from any to <abusers1d>
block log quick from any to <level2>
block log quick from any to <level3>
block log quick from any to <webclient>
block log quick from any to <csix>
block log quick from any to <bad_actors>

# Block UDP 443 except to Umbrella DNS (important as some apps use this)
block log proto udp from any to any port {80, 443}

# IPv6 ICMP
pass in log inet6 proto ipv6-icmp icmp6-type 134
pass in log inet6 proto ipv6-icmp icmp6-type 135
pass in log inet6 proto ipv6-icmp icmp6-type 136

